
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lab 40 — Bayesian Perception</title>
  <style>
    body { background:#000; color:#0f0; font-family:monospace; }
    .row { display:flex; gap:12px; }
    canvas {
      border:1px solid #0f0;
      image-rendering:pixelated;
    }
    pre {
      max-height:260px;
      overflow:auto;
      border:1px solid #0f0;
      padding:4px;
    }
  </style>
</head>
<body>
<h1>Lab 40 — Observer Holography II: Bayesian Perception</h1>
<button onclick="loadFrame()">reload frame_000.json</button>
<div class="row">
  <div>
    <div>true field</div>
    <canvas id="true" width="256" height="256"></canvas>
  </div>
  <div>
    <div>noisy observation</div>
    <canvas id="obs" width="256" height="256"></canvas>
  </div>
  <div>
    <div>MAP reconstruction</div>
    <canvas id="recon" width="256" height="256"></canvas>
  </div>
</div>
<pre id="log">no data yet</pre>
<script>
function drawGray(canvas, data2d){
  const rows = data2d.length;
  const cols = data2d[0].length;
  canvas.width = cols;
  canvas.height = rows;
  canvas.style.width = "256px";
  canvas.style.height = "256px";
  const ctx = canvas.getContext('2d');
  let min = Infinity, max = -Infinity;
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      const v = data2d[y][x];
      if (v < min) min = v;
      if (v > max) max = v;
    }
  }
  const img = ctx.createImageData(cols,rows);
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      const v = data2d[y][x];
      let t = (v - min) / (max - min + 1e-6);
      t = Math.max(0, Math.min(1, t));
      const i = (y*cols+x)*4;
      const g = Math.floor(255*t);
      img.data[i] = 0;
      img.data[i+1] = g;
      img.data[i+2] = 0;
      img.data[i+3] = 255;
    }
  }
  ctx.putImageData(img,0,0);
}
async function loadFrame(){
  const log = document.getElementById('log');
  try{
    const resp = await fetch('../data/lab40/frame_000.json');
    if (!resp.ok){
      log.textContent = 'no frame_000.json yet for lab40 (run lab40.py or run_all.py)';
      return;
    }
    const data = await resp.json();
    drawGray(document.getElementById('true'), data.true);
    drawGray(document.getElementById('obs'), data.obs);
    drawGray(document.getElementById('recon'), data.recon);
    const Ehist = data.E_hist || [];
    const lastE = Ehist.length ? Ehist[Ehist.length-1] : null;
    log.textContent = 'frames of descent: ' + Ehist.length +
                      (lastE !== null ? '\nfinal energy ≈ ' + lastE.toFixed(4) : '');
  }catch(e){
    log.textContent = 'error: '+e;
  }
}
window.onload = loadFrame;
</script>
</body>
</html>
